# 小盘古架构设计方案（建议版）

## 一、核心理念重构

### 1.1 上下文管理策略
**分层记忆、按需加载、智能索引、无时间依赖**

### 1.2 核心问题解决思路
```
问题：上下文记忆负荷 vs 窗口切换丢失
解决方案：
1. 建立"记忆索引系统"而非"全量记忆"
2. 设计"任务交接协议"而非"时间节点"
3. 实现"按需加载上下文"而非"一次性全载入"
```

## 二、项目结构重构（上下文友好）

```
小盘古项目根目录/
├── 📁 项目司令部/
│   ├── 总纲宪章.md           # 永远的核心，不超过1000字
│   ├── 当前阶段.md           # 当前阶段和核心任务
│   ├── 记忆索引.json         # 所有重要信息的"目录"
│   └── 任务交接.md           # 当前任务的交接说明
├── 📁 锚点核心库/
│   ├── 协议系统/             # 所有协议相关锚点
│   │   ├── 00_协议总则.md     # 协议基础原则
│   │   ├── 01_权限协议.md     # 权限申请流程
│   │   └── 02_进化协议.md     # 进化执行流程
│   ├── 功能系统/             # 所有功能相关锚点
│   │   ├── 10_自我感知.md     # 自我描述能力
│   │   ├── 11_文件操作.md     # 文件读写能力
│   │   └── 12_记忆系统.md     # 记忆管理能力
│   └── 验证系统/             # 验证标准锚点
│       └── 20_验证协议.md     # 如何验证功能
├── 📁 源代码/                # 按功能组织代码
│   ├── 核心引擎/             # 不可替换的核心
│   ├── 协议执行器/           # 协议相关代码
│   └── 功能模块/             # 可插拔的功能
├── 📁 记忆仓库/              # 系统记忆存储
│   ├── 用户偏好/             # 用户习惯记忆
│   ├── 项目历史/             # 项目进展记忆
│   └── 经验知识/             # 学到的知识
├── 📁 交接档案/              # 窗口切换专用
│   ├── 上次任务总结.md
│   ├── 当前任务状态.md
│   └── 下一步计划.md
└── 📄 快速启动指南.md         # 如何开始对话
```

## 三、上下文管理机制设计

### 3.1 记忆索引系统
```json
{
  "记忆索引": {
    "协议系统": {
      "权限协议": "锚点核心库/协议系统/01_权限协议.md",
      "进化协议": "锚点核心库/协议系统/02_进化协议.md",
      "验证协议": "锚点核心库/协议系统/20_验证协议.md"
    },
    "功能系统": {
      "自我感知": "锚点核心库/功能系统/10_自我感知.md",
      "文件操作": "锚点核心库/功能系统/11_文件操作.md",
      "记忆系统": "锚点核心库/功能系统/12_记忆系统.md"
    },
    "当前状态": {
      "所在阶段": "阶段一：内核育成期",
      "进行中任务": "任务01：建立自我感知能力",
      "最近进展": "已完成基础框架，需要完善验证机制",
      "信任积分": 15
    },
    "最近修改": [
      {"文件": "src/核心引擎/自我感知.py", "时间": "2024-01-15", "修改内容": "增加状态报告功能"}
    ]
  }
}
```

### 3.2 任务交接协议
```
# 任务交接协议

## 核心原则
1. 每次窗口切换，必须更新交接档案
2. 交接档案必须包含：做了什么、当前状态、下一步计划
3. 新窗口启动时，先读交接档案，再决定加载哪些上下文

## 交接档案结构
交接档案/当前任务状态.md:
---
任务ID: TASK_001
任务名称: 建立自我感知能力
任务状态: 进行中（完成度70%）
已完成部分:
  - 创建了自我感知锚点文档
  - 实现了基础的状态报告功能
  - 编写了验证测试脚本
待完成部分:
  - 完善状态报告的细节
  - 增加性能监控功能
  - 完成所有验证测试
关键文件:
  - 锚点: 锚点核心库/功能系统/10_自我感知.md
  - 代码: src/核心引擎/自我感知.py
  - 测试: tests/自我感知测试.py
注意事项:
  - 状态报告需要包含代码结构、能力列表、当前负载
  - 性能监控要避免影响系统运行
下一步计划:
  1. 完善状态报告的细节（预计1小时）
  2. 增加性能监控功能（预计2小时）
  3. 运行所有验证测试（预计1小时）
---
```

### 3.3 按需加载上下文策略
```
与AI对话时的上下文加载策略：

第一层（必须加载，不超过500字）：
1. 总纲宪章.md的核心摘要（100字）
2. 当前阶段.md的目标摘要（100字）
3. 记忆索引.json的当前状态部分（100字）
4. 交接档案/当前任务状态.md（200字）

第二层（按需加载）：
- 如果涉及协议，加载相关协议锚点（单个文件）
- 如果涉及功能，加载相关功能锚点（单个文件）
- 如果涉及代码，只加载相关代码片段（不超过50行）

第三层（避免加载）：
- 不加载完整历史日志
- 不加载所有锚点文档
- 不加载完整源代码
```

## 四、阶段重构（无时间依赖）

### 阶段一：内核育成期 - "生命单元"
**目标状态**：系统能自我感知、遵循协议、完成基础进化

#### 核心任务清单：
```
任务01：建立自我感知能力
  - 创建锚点：10_自我感知.md
  - 实现功能：系统能清晰描述自己的代码结构、能力边界、当前状态
  - 验证标准：运行命令，系统能输出完整的自我描述报告
  
任务02：建立权限协议体系
  - 创建锚点：01_权限协议.md
  - 实现功能：分级权限系统（L1观察、L2操作、L3变更、L4生态）
  - 验证标准：系统在执行任何操作前都能正确申请权限并记录
  
任务03：实现安全文件操作
  - 创建锚点：11_文件操作.md
  - 实现功能：安全的文件读写能力，与权限系统集成
  - 验证标准：系统能安全地读取配置、写入日志
  
任务04：完成首次闭环进化
  - 创建锚点：02_进化协议.md
  - 实现功能：系统能诊断自身，提出改进建议，在监督下执行改进
  - 验证标准：在用户监督下成功完成一次自我改进
  
任务05：建立记忆系统基础
  - 创建锚点：12_记忆系统.md
  - 实现功能：能存储和读取基础记忆（用户偏好、操作历史）
  - 验证标准：系统能记住用户的基本偏好并在新对话中应用
  
任务06：建立验证系统
  - 创建锚点：20_验证协议.md
  - 实现功能：每个功能完成后都有验证流程
  - 验证标准：系统能自动运行验证测试并报告结果
```

#### 准出条件（状态条件）：
1. ✅ 自我感知功能通过所有验证测试
2. ✅ 权限协议系统在三种不同场景下正确工作
3. ✅ 成功完成至少一次闭环进化
4. ✅ 记忆系统能正确存储和读取基础信息
5. ✅ 所有核心任务的验证测试通过
6. ✅ 用户确认系统达到"稳定工作状态"

---

### 阶段二：能力构筑期 - "模块化生长"
**目标状态**：模块化架构、记忆系统、多模型协作基础

#### 核心任务清单：
```
任务07：完成模块化重构
  - 创建锚点：13_模块化架构.md
  - 实现功能：将单脚本系统重构为模块化架构
  - 验证标准：各模块能独立运行并通过接口通信
  
任务08：建立结构化记忆系统
  - 创建锚点：12_记忆系统.md（升级）
  - 实现功能：能存储项目历史、对话上下文、决策记录
  - 验证标准：系统能基于历史记忆做出更好决策
  
任务09：实现任务规划能力
  - 创建锚点：14_任务规划.md
  - 实现功能：对复杂任务进行分解、规划、执行、汇报
  - 验证标准：给定中级任务，系统能正确分解并执行
  
任务10：建立多模型协作框架 ★（关键调整）
  - 创建锚点：15_模型协作.md
  - 实现功能：设计可插拔的模型调用框架
  - 设计原则：
    a. 初期：使用单一主要模型（如GPT-4）完成所有功能
    b. 框架：预留其他模型接口，但不强制实现
    c. 目标：让系统"知道"未来可能使用多模型，但不增加复杂度
  - 验证标准：框架设计合理，能支持未来扩展
  
任务11：建立上下文管理系统
  - 创建锚点：16_上下文管理.md
  - 实现功能：智能管理对话上下文，按需加载信息
  - 验证标准：长对话中能有效管理上下文，避免丢失重要信息
```

#### 准出条件：
1. ✅ 模块化架构稳定运行
2. ✅ 记忆系统能正确存储和调用项目历史
3. ✅ 能独立完成三个以上中级复杂度任务
4. ✅ 上下文管理系统有效工作
5. ✅ 多模型协作框架设计完成并通过评审

---

### 阶段三：认知融合期 - "智能协同"
**目标状态**：意图理解、方案创新、自主优化

#### 核心任务清单：
```
任务12：实现意图深度理解
  - 创建锚点：17_意图理解.md
  - 实现功能：结合用户历史、行为模式洞察潜在需求
  - 验证标准：能正确理解模糊需求并提出澄清问题
  
任务13：建立方案创新与评估系统
  - 创建锚点：18_方案创新.md
  - 实现功能：对复杂问题提供多套方案并评估利弊
  - 验证标准：给定复杂问题，能提出至少两种解决方案
  
任务14：实现自主优化能力
  - 创建锚点：19_自主优化.md
  - 实现功能：在不偏离核心目标下自主优化架构
  - 验证标准：系统能定期提出优化建议并执行低风险优化
  
任务15：建立知识关联系统 ★（关键调整）
  - 创建锚点：21_知识关联.md
  - 设计原则：
    a. 不是构建完整的知识图谱
    b. 而是建立"经验关联"：将类似问题、类似解决方案关联
    c. 目标：当遇到新问题时，能参考历史类似问题的解决方式
  - 实现功能：建立问题-解决方案的关联记忆
  - 验证标准：遇到新问题时，能参考历史类似案例
  
任务16：实现多智能体协作模式
  - 创建锚点：22_智能体协作.md
  - 实现功能：系统内部能协调不同功能模块协作
  - 验证标准：复杂任务能由多个功能模块协作完成
```

#### 准出条件：
1. ✅ 能正确理解并执行模糊指令
2. ✅ 能独立提出创新性解决方案
3. ✅ 知识关联系统能有效工作
4. ✅ 成功完成至少五次自主优化
5. ✅ 多智能体协作模式经过验证

---

### 阶段四：共生进化期 - "数字分身"
**目标状态**：预见性行动、个性化能力、价值对齐

#### 核心任务清单：
```
任务17：实现预见性行动能力
  - 创建锚点：23_预见性行动.md
  - 实现功能：基于用户习惯主动提出建议和预警
  - 验证标准：能提前发现用户潜在需求并主动准备
  
任务18：发展个性化能力组合
  - 创建锚点：24_个性化进化.md
  - 实现功能：进化出适应用户工作流的独特能力
  - 验证标准：拥有至少三个用户专属的个性化功能
  
任务19：内化价值判断体系
  - 创建锚点：25_价值对齐.md
  - 实现功能：在决策中体现与用户一致的价值观
  - 验证标准：复杂决策时的价值取向与用户高度一致
  
任务20：实现共识共创协作
  - 创建锚点：26_共识共创.md
  - 实现功能：与用户自然分工，无缝协作探索未知
  - 验证标准：与用户合作完成一个创新性探索项目
  
任务21：建立动态知识演进系统 ★（关键调整）
  - 创建锚点：27_知识演进.md
  - 设计原则：
    a. 不是静态的知识图谱
    b. 而是动态的"经验进化"：新经验能更新旧认知
    c. 目标：系统知识能随时间和经验增长而进化
  - 实现功能：知识系统能随时间演进和优化
  - 验证标准：三个月前的认知能被新经验更新
```

#### 终极目标达成标志：
1. 🔄 系统与用户的协作达到无缝程度
2. 🔄 系统能力成为用户能力的自然延伸
3. 🔄 用户愿意将重要决策委托给系统
4. 🔄 形成稳定的共生进化节奏
5. 🔄 知识系统能自主演进和优化

## 五、上下文优化的AI协作方案

### 5.1 对话启动协议
```
每次新对话，按照以下顺序提供信息：

第一段（核心上下文，不超过300字）：
"项目：小盘古数字分身系统
当前阶段：[阶段名称，如：阶段一：内核育成期]
当前任务：[任务名称，如：任务01：建立自我感知能力]
任务状态：[状态描述，如：已完成基础框架，需要完善细节]
信任积分：[当前积分]

关键参考文件：
- 锚点：[相关锚点文件名，如：10_自我感知.md]
- 代码：[相关代码文件，如：src/核心引擎/自我感知.py]

下一步计划：[具体下一步行动]"

第二段（具体请求）：
"请协助完成：[具体请求内容]"

第三段（约束条件）：
"注意事项：
1. 所有修改必须遵循权限协议
2. 完成后需要更新相关锚点文档
3. 需要编写验证测试
4. 更新记忆索引中的最近修改记录"
```

### 5.2 任务进展记录协议
```
每个任务进展后，必须更新：
1. 交接档案/当前任务状态.md（更新任务状态）
2. 记忆索引.json（更新最近修改记录）
3. 相关锚点文档（如果有修改）

更新原则：
- 简洁明了，重点记录"改变了什么"
- 包含"为什么改变"的原因
- 记录验证结果
- 更新下一步计划
```

### 5.3 窗口切换交接协议
```
当需要切换AI窗口时：

第一步：完成当前小任务
- 确保当前小任务达到一个"可暂停点"
- 运行验证测试，确保功能正常

第二步：更新交接档案
- 更新交接档案/上次任务总结.md（刚才做了什么）
- 更新交接档案/当前任务状态.md（当前状态）
- 更新交接档案/下一步计划.md（下一步做什么）

第三步：准备新窗口启动包
- 从记忆索引.json提取核心信息
- 从交接档案生成"新窗口启动指南"
- 确保所有必要文件都有明确路径

新窗口启动指南内容（不超过400字）：
---
刚才完成了：[具体完成内容]
当前任务状态：[详细状态描述]
关键文件位置：
  锚点文件：[路径]
  代码文件：[路径]
  测试文件：[路径]
下一步计划：[具体下一步]
需要特别注意：[特别注意事项]
---
```

## 六、关键设计调整说明

### 6.1 关于多模型协作的调整
```
原问题：模型的调用是在阶段二初期就要使用了吧？不然哪些读写功能如何完成？记忆力如何实现？

调整方案：
1. 阶段一：使用单一模型（如GPT-4）完成所有功能
   - 读写功能：通过API调用实现
   - 记忆力：通过本地文件存储实现
   - 所有功能都由同一个模型驱动

2. 阶段二：建立多模型协作"框架"，但不强制使用多模型
   - 设计接口：定义模型调用标准接口
   - 预留扩展：为未来添加其他模型预留位置
   - 当前实现：仍然使用单一模型，但代码结构支持多模型

3. 阶段三/四：根据需要逐步引入多模型
   - 当单一模型无法满足需求时
   - 当特定任务需要专用模型时
   - 当性能或成本考虑需要多模型时
```

### 6.2 关于知识系统的调整
```
原问题：构建知识图谱的方案是为了解决某一类或者某个领域的问题，并不是ai助手了吧？

调整方案：
1. 不构建"通用知识图谱"
   - 因为AI助手本身已有大量通用知识
   - 不需要重复构建百科全书

2. 构建"个性化经验关联系统"
   - 记录：用户的具体问题、解决方案
   - 关联：相似问题的相似解决方案
   - 演进：新经验更新旧认知

3. 目标：让系统更懂"这个用户"，而不是更懂"这个世界"
```

### 6.3 关于记忆系统的调整
```
原问题：ai助手，ai数字分身，可能要面对的领域更广泛一些吧？

调整方案：
1. 短期记忆：当前对话上下文
   - 通过AI的上下文窗口管理
   - 重要信息提取到长期记忆

2. 长期记忆：结构化存储
   - 用户偏好：用户习惯和偏好
   - 项目历史：项目进展和决策
   - 经验知识：学到的问题解决方法

3. 记忆检索：按需加载
   - 不是一次性加载所有记忆
   - 根据当前任务加载相关记忆
   - 建立记忆之间的关联索引
```

## 七、实施指南（无时间依赖）

### 7.1 开始实施
```
第一步：创建项目结构
- 按照上述结构创建所有目录
- 创建核心文档（总纲宪章、当前阶段）

第二步：启动第一个任务
- 选择任务01：建立自我感知能力
- 创建锚点文档：10_自我感知.md
- 开始编写代码

第三步：建立工作节奏
- 每次对话前：读交接档案，了解当前状态
- 每次对话中：专注于当前小任务
- 每次对话后：更新交接档案，记录进展
```

### 7.2 进展评估
```
进展评估标准（无时间限制）：
1. 功能完成度：功能是否实现
2. 验证通过率：验证测试是否通过
3. 代码质量：代码是否清晰可维护
4. 文档完整性：相关文档是否完善
5. 用户满意度：是否达到用户期望

何时进入下一阶段：
当当前阶段的所有核心任务都达到"完成状态"
完成状态 = 功能实现 + 验证通过 + 文档完善
```

### 7.3 遇到困难时的调整
```
问题：任务太大，无法在一次对话中完成
解决：将任务分解为更小的子任务

问题：上下文丢失，AI忘记之前的工作
解决：完善交接档案，提供更清晰的上下文

问题：方向偏离，系统发展不符合预期
解决：回顾总纲宪章，重新对齐目标

问题：复杂度增加，难以管理
解决：加强模块化，简化接口设计
```

## 八、成功的关键习惯

### 必须坚持的习惯：
1. **每次对话后更新交接档案**
   - 记录做了什么
   - 更新任务状态
   - 明确下一步计划

2. **新对话前读取交接档案**
   - 了解当前状态
   - 明确当前任务
   - 知道下一步计划

3. **按需加载上下文**
   - 不一次性加载所有信息
   - 只加载当前任务需要的
   - 通过记忆索引快速定位

4. **小步快跑**
   - 每次对话完成一个小目标
   - 每个小目标都有明确产出
   - 每个产出都有验证测试

### 建议的工具支持：
1. **自动化脚本**：自动更新记忆索引
2. **模板文件**：快速创建交接档案
3. **搜索工具**：快速找到相关文件
4. **验证框架**：自动运行验证测试

## 九、立即开始清单

### 今天可以完成：
1. [ ] 创建项目目录结构
2. [ ] 创建总纲宪章.md（从原文档提炼）
3. [ ] 创建当前阶段.md（设定为阶段一）
4. [ ] 创建记忆索引.json（基础结构）
5. [ ] 创建交接档案目录和基础文件
6. [ ] 创建快速启动指南.md

### 第一次AI对话内容：
```
项目：小盘古数字分身系统
当前阶段：阶段一：内核育成期
当前任务：任务01：建立自我感知能力
任务状态：尚未开始，需要创建基础框架
信任积分：0

关键参考文件：
- 锚点：需要创建10_自我感知.md
- 代码：需要创建src/核心引擎/自我感知.py

下一步计划：创建自我感知功能的锚点文档和基础代码

请协助完成：
1. 创建锚点文档：10_自我感知.md
2. 设计自我感知的数据结构
3. 实现基础的自我描述函数

注意事项：
1. 这是项目的第一个功能，需要建立良好基础
2. 代码需要清晰易读，便于后续扩展
3. 完成后需要创建验证测试
```

---

这个方案完全**去除了时间依赖**，专注于**任务状态**和**上下文管理**。通过记忆索引、交接档案和按需加载策略，解决了AI上下文限制和窗口切换问题。同时，对多模型协作和知识系统进行了合理调整，使其更符合AI数字分身的实际需求。

**最关键的是建立良好的上下文管理习惯**，确保每次对话都能在有限的上下文中高效工作。
