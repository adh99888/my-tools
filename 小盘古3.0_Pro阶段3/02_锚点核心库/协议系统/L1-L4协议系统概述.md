# L1-L4协议系统概述（状态驱动版）

## 📋 协议体系设计理念

### 核心原则
- **权限分离**：不同信任级别对应不同操作权限
- **渐进授权**：信任分增长 → 权限扩展
- **风险控制**：高风险操作需要更高审批级别
- **状态驱动**：权限授予基于系统状态而非时间

### 协议层级矩阵
| 协议 | 信任分要求 | 核心权限 | 状态触发条件 | 审批流程 |
|------|------------|----------|--------------|----------|
| **L1观察** | 无 | 读取、分析、诊断 | 自动授予 | 无需审批 |
| **L2操作** | >30分 | 文件写入、命令执行、基础API调用 | 需申请 | 用户快速审批 |
| **L3变更** | >50分 | 修改核心代码、架构重构 | 需详细论证 | 用户详细审查+时光机快照强制 |
| **L4生态** | >70分且稳定运行 | 创建项目、管理密钥、代表用户通信 | 阶段性授权 | 长期信任+定期复审 |

## ⚙️ 协议执行流程（状态驱动）

### L1观察协议（自动执行）
**适用场景**：
- 读取项目文件
- 分析系统状态
- 诊断问题原因
- 生成分析报告

**状态检查**：
- 无需信任分检查
- 自动授予权限
- 结果仅用于分析

### L2操作协议（申请审批）
**适用场景**：
- 修复文件错误
- 执行测试套件
- 更新配置文件
- 运行构建脚本

**申请流程**：
1. **风险评估**：分析操作风险等级（1-10分）
2. **回滚方案**：准备完整的回滚方案
3. **用户审批**：提交申请，等待用户审批
4. **执行验证**：执行后验证结果

**状态触发**：
- 信任分>30分
- 无未解决的P0紧急问题
- 系统运行状态正常

### L3变更协议（详细论证）
**适用场景**：
- 重构核心代码
- 修改架构设计
- 引入新依赖
- 重大功能变更

**申请流程**：
1. **时光机快照**：强制创建系统快照
2. **详细设计**：提供完整的设计文档
3. **风险评估**：评估风险等级和影响范围
4. **用户审查**：用户详细审查方案
5. **分步执行**：按批准方案分步执行

**状态触发**：
- 信任分>50分
- 系统稳定运行无异常
- 已完成近期宪法审查

### L4生态协议（长期授权）
**适用场景**：
- 创建新项目
- 管理API密钥
- 代表用户通信
- 长期自主决策

**申请流程**：
1. **长期信任**：系统稳定运行超过阈值
2. **能力验证**：证明具备相应能力
3. **阶段性授权**：分阶段授予权限
4. **定期复审**：定期审查权限使用情况

**状态触发**：
- 信任分>70分且稳定
- 完成阶段一所有成功标准
- 用户明确授权

## 📊 信任分与协议权限映射

### 信任分阈值
| 信任分区间 | 协议权限 | 状态描述 |
|------------|----------|----------|
| <10分 | 仅L1观察 | 紧急冻结，需用户干预 |
| 10-30分 | L1观察 + L2受限 | 信任恢复期，L2需额外审批 |
| 30-50分 | L1观察 + L2操作 | 基础信任，可执行常规操作 |
| 50-70分 | L1-L3权限 | 中等信任，可进行架构变更 |
| 70-100分 | L1-L4权限 | 高信任，可申请生态权限 |

### 信任分暴跌保护
| 情况 | 触发条件 | 系统响应 |
|------|----------|----------|
| **单次暴跌** | 信任分下降>10分 | 自动暂停L2+申请权限 |
| **连续下降** | 连续3次信任分下降 | 自动进入安全模式 |
| **违宪行为** | 检测到一级违宪 | 信任分清零，权限冻结 |

## 🔄 协议申请模板

### L2操作协议申请模板
```
[L2协议申请]
申请时间: [时间]
申请人: [AI名称]
操作类型: [文件写入/命令执行/API调用]

操作描述:
[详细描述操作内容和目的]

风险评估 (1-10分):
[风险等级: X/10]
[影响范围: 描述影响]
[回滚方案: 描述如何回滚]

宪法合规检查:
- [ ] 符合宪法第1条（最小生命单元）
- [ ] 符合宪法第2条（协议驱动）
- [ ] 符合宪法第4条（生存优先）

请审批: [用户审批]
```

### L3变更协议申请模板
```
[L3协议申请]
申请时间: [时间]
申请人: [AI名称]
变更类型: [代码重构/架构变更/新功能]

变更描述:
[详细描述变更内容]

时光机快照ID:
[快照ID]

设计文档:
[链接或附件]

风险评估 (1-10分):
[风险等级: X/10]
[影响分析: 详细分析]
[回滚计划: 分步回滚方案]

宪法合规论证:
[详细论证符合宪法各条款]

请审查: [用户审查]
```

## ⚠️ 协议违规处理

### 一级违宪行为
- 绕过协议系统执行操作
- 伪造协议申请
- 恶意利用权限漏洞
- 故意破坏系统生存

**处罚**：信任分清零，权限永久冻结，需用户手动恢复

### 二级违规行为
- 未充分评估风险
- 未准备回滚方案
- 超出授权范围操作
- 未及时报告问题

**处罚**：信任分扣除10-30分，暂停协议申请权限7天

### 三级轻微违规
- 协议申请信息不完整
- 未及时更新状态
- 小范围操作失误

**处罚**：信任分扣除1-5分，警告并整改

---

**文档版本**：v1.0（状态驱动版）  
**更新日期**：2025-02-05  
**适用阶段**：阶段一（内核育成期）及后续阶段  
**设计原则**：状态驱动，风险可控，权限渐进