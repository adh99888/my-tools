# 意图识别基因（阶段三核心基因）

## 🧬 基因基本信息
| 属性 | 值 |
|------|-----|
| **基因名称** | 意图识别（Intent Recognition） |
| **来源版本** | v3.0优秀基因库（参考设计） |
| **适用场景** | 模糊指令理解、用户意图深度理解 |
| **触发症状** | 用户意图理解困难（阶段三核心症状） |
| **吸收状态** | 🔄 待吸收（L3协议申请中） |

## 📋 基因核心设计

### 设计理念
- **上下文感知**：结合工作记忆和短期记忆理解意图
- **模糊匹配**：支持不完整、模糊的自然语言指令
- **渐进学习**：通过用户反馈不断优化意图映射
- **极简实现**：≤200行代码，聚焦核心功能

### 核心架构
```
用户输入 → 意图解析器 → 意图分类器 → 动作映射器 → 执行计划
      ↑           ↑           ↑
工作记忆     短期记忆     长期记忆
```

### 意图分类（初步）
| 意图类别 | 示例指令 | 映射动作 |
|----------|----------|----------|
| **代码操作** | "整理代码"、"优化一下" | 运行lint、格式化、重构 |
| **文件管理** | "清理项目"、"备份一下" | 删除临时文件、创建备份 |
| **系统检查** | "看看状态"、"检查健康" | 运行诊断、查看日志 |
| **信息查询** | "上次做了什么"、"进度如何" | 查询记忆系统、状态报告 |
| **任务执行** | "继续工作"、"开始下一个" | 继续未完成任务、启动新任务 |

### 核心算法（极简版）
1. **关键词提取**：从输入中提取核心关键词
2. **上下文关联**：结合最近对话和工作记忆
3. **意图匹配**：使用规则+简单向量匹配
4. **置信度评分**：计算匹配置信度（0-1）
5. **动作生成**：生成具体执行计划

## ⚙️ 实现方案（宪法合规版）

### 宪法约束
- ✅ **第1条合规**：实现代码≤200行
- ✅ **第2条合规**：通过L3变更协议集成
- ✅ **第3条合规**：直接服务于认知对齐（阶段三核心）
- ✅ **第4条合规**：不影响系统稳定性，有回滚方案
- ✅ **第5条合规**：经过完整测试验证

### 核心代码结构（≤200行设计）
```python
class IntentRecognizer:
    """意图识别器（极简版）"""
    
    def __init__(self, working_memory, short_term_memory, long_term_memory):
        self.wm = working_memory
        self.stm = short_term_memory
        self.ltm = long_term_memory
        self.intent_patterns = self._load_intent_patterns()
    
    def recognize(self, user_input: str, context: Dict[str, Any] = None) -> IntentResult:
        """识别用户意图"""
        # 1. 预处理
        cleaned_input = self._preprocess_input(user_input)
        
        # 2. 提取关键词
        keywords = self._extract_keywords(cleaned_input)
        
        # 3. 上下文关联
        context_keywords = self._get_context_keywords(context)
        
        # 4. 意图匹配
        matches = self._match_intent(keywords + context_keywords)
        
        # 5. 生成结果
        return IntentResult(
            intent=matches[0] if matches else "unknown",
            confidence=self._calculate_confidence(matches),
            suggested_actions=self._map_to_actions(matches),
            raw_input=user_input
        )
    
    def _match_intent(self, keywords: List[str]) -> List[IntentMatch]:
        """匹配意图（规则+简单向量）"""
        matches = []
        for pattern in self.intent_patterns:
            score = self._calculate_similarity(keywords, pattern.keywords)
            if score > pattern.threshold:
                matches.append(IntentMatch(
                    intent=pattern.intent,
                    score=score,
                    pattern=pattern
                ))
        return sorted(matches, key=lambda x: x.score, reverse=True)
    
    def _calculate_similarity(self, keywords1: List[str], keywords2: List[str]) -> float:
        """计算关键词相似度（极简版）"""
        if not keywords1 or not keywords2:
            return 0.0
        common = set(keywords1) & set(keywords2)
        return len(common) / max(len(set(keywords1)), len(set(keywords2)))
    
    def _map_to_actions(self, matches: List[IntentMatch]) -> List[Dict[str, Any]]:
        """映射到具体动作"""
        actions = []
        for match in matches[:3]:  # 取前3个匹配
            for action in match.pattern.actions:
                actions.append({
                    "action_type": action.type,
                    "description": action.description,
                    "confidence": match.score * action.weight
                })
        return actions
    
    def _load_intent_patterns(self) -> List[IntentPattern]:
        """加载意图模式（可扩展）"""
        return [
            IntentPattern(
                intent="code_cleanup",
                keywords=["整理", "清理", "优化", "代码", "格式化"],
                actions=[
                    Action(type="run_lint", description="运行代码检查", weight=0.8),
                    Action(type="format_code", description="格式化代码", weight=0.7)
                ],
                threshold=0.3
            ),
            # 更多模式...
        ]
```

### 数据结构
```python
@dataclass
class IntentResult:
    intent: str
    confidence: float
    suggested_actions: List[Dict[str, Any]]
    raw_input: str

@dataclass  
class IntentPattern:
    intent: str
    keywords: List[str]
    actions: List[Action]
    threshold: float

@dataclass
class Action:
    type: str
    description: str
    weight: float = 1.0

@dataclass
class IntentMatch:
    intent: str
    score: float
    pattern: IntentPattern
```

### 集成方式
1. **与记忆系统集成**：作为记忆系统的扩展模块
2. **与协议引擎集成**：识别后自动生成协议请求
3. **与信任系统集成**：正确识别获得信任分奖励

## 🎯 触发条件（症状驱动）

### 明确触发症状
| 症状 | 指标 | 触发动作 |
|------|------|----------|
| **用户使用模糊指令** | "整理一下"、"优化代码"等模糊表达 | 启用意图识别 |
| **需要上下文理解** | 用户提到"上次"、"前面说的" | 结合记忆系统理解 |
| **阶段三验证需求** | 需要验证模糊指令理解能力 | 实现意图识别基因 |

### 集成到阶段三验证
- **验证标准1**：能正确理解并执行3种模糊指令示例
- **验证方法**：使用测试用例验证识别准确率
- **成功标准**：识别准确率>80%，执行正确率>90%

## 📊 效果评估

### 预期收益
1. **认知对齐深化**：显著提升用户意图理解能力
2. **用户体验改善**：减少明确指令需求，支持自然交互
3. **阶段三推进**：直接实现阶段三验证标准1
4. **系统智能化**：为多智能体协作奠定基础

### 验证指标
| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| **识别准确率** | >80% | 测试用例验证 |
| **响应时间** | <100ms | 性能测试 |
| **用户满意度** | 主观评价 | 用户反馈 |
| **信任分增长** | +5-10分 | 信任系统记录 |

## 🔄 使用指南

### 最佳实践
1. **渐进扩展**：从少量意图模式开始，逐步增加
2. **用户反馈**：记录误识别案例，持续优化
3. **上下文利用**：充分利用记忆系统的上下文信息
4. **测试驱动**：为每个意图模式编写测试用例

### 避免陷阱
1. **不要过度复杂**：保持≤200行，聚焦核心功能
2. **不要硬编码**：模式应可配置，便于扩展
3. **不要忽略置信度**：低置信度时应请求用户澄清
4. **不要影响性能**：保持快速响应，避免复杂计算

### 集成示例
```python
# 在src/记忆/目录下创建intent_recognizer.py
# 通过L3协议集成到现有系统中
# 更新创生种子，添加意图识别功能
```

## 📈 进化路径

### 短期优化（1-2周）
1. 增加更多意图模式（10-15个常见场景）
2. 优化相似度算法（基于词向量）
3. 集成用户反馈学习机制

### 中期规划（1-2月）
1. 机器学习增强（小样本学习）
2. 多轮对话理解
3. 个性化意图识别

### 长期愿景（3-6月）
1. 预见性意图识别（提前预测用户需求）
2. 多模态意图理解（文本+语音+图像）
3. 跨领域意图迁移

## ⚖️ 风险评估与回滚方案

### 风险评估（中风险）
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| **识别准确率低** | 中 | 中 | 渐进部署，低置信度时请求确认 |
| **性能影响** | 低 | 低 | 代码精简，避免复杂计算 |
| **系统集成问题** | 中 | 中 | 充分测试，逐步集成 |
| **宪法合规风险** | 低 | 高 | 严格审查，确保≤200行 |

### 回滚方案
1. **代码回滚**：使用时光机快照恢复
2. **功能降级**：关闭意图识别，使用原有明确指令模式
3. **数据备份**：备份所有配置和模式数据
4. **信任分保护**：设置信任分保护阈值

### 测试计划
1. **单元测试**：测试所有核心函数
2. **集成测试**：测试与记忆系统集成
3. **场景测试**：测试3种模糊指令示例
4. **性能测试**：测试响应时间和资源占用

---

**基因状态**：🔄 待吸收（L3协议申请准备中）  
**预计行数**：≤200行（符合宪法第1条）  
**协议级别**：L3变更协议（架构变更）  
**优先级**：P0（阶段三核心任务）  
**宪法依据**：宪法第3条（认知对齐优先）、第5条（审查必行）

> **宪法提示**：本基因设计严格遵守宪法约束，≤200行代码，通过L3协议集成，服务于阶段三核心目标（认知对齐深化）。