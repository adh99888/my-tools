# 阶段二用户监督任务协作机制设计

## 📋 设计背景

**宪法依据**：宪法第3条（认知对齐优先原则）、第4条（生存优先原则）
**阶段定位**：阶段二（能力构筑期） - 任务协作模式（用户下达任务目标，AI自主规划子步骤）
**设计目的**：填补阶段二缺失的用户监督机制，确保任务协作过程中用户保持适当控制和知情权

## 🎯 设计目标

### 核心问题解决
当前阶段二协作模式定义（用户下达任务目标，AI自主规划子步骤）缺少具体监督机制：
- ❌ 用户无法实时了解任务进展
- ❌ 用户无法在关键节点审批
- ❌ 用户无法中途调整任务方向
- ❌ 缺乏风险预警和异常报告机制

### 设计原则
1. **透明原则**：任务执行全程对用户透明
2. **可控原则**：用户可在关键节点介入和控制
3. **渐进原则**：监督强度随信任分动态调整
4. **效率原则**：监督不阻碍正常任务执行流程

## 🔧 监督机制设计

### 1. 任务分解与审批点机制

#### 任务分解标准
```python
class TaskDecomposer:
    """任务分解器"""
    
    def decompose(self, task_goal: str, trust_score: float) -> List[TaskStep]:
        """
        根据信任分解任务为子步骤
        - 信任分<60: 细粒度分解（3-5步，每步需审批）
        - 信任分60-80: 中粒度分解（2-3步，关键步骤审批）
        - 信任分>80: 粗粒度分解（1-2步，仅最终结果审批）
        """
```

#### 审批点类型
| 审批点类型 | 触发条件 | 用户操作 | 超时处理 |
|-----------|---------|---------|---------|
| **启动审批** | 任务开始前 | 批准/拒绝/修改 | 默认拒绝 |
| **关键步骤审批** | 高风险操作前 | 批准/跳过/调整参数 | 默认跳过（记录） |
| **异常审批** | 计划外情况 | 选择处理方案 | 默认安全方案 |
| **完成确认** | 任务完成后 | 确认/要求修改 | 默认确认 |

### 2. 实时进展报告机制

#### 报告频率
- **高频报告**（信任分<60）：每5分钟或每完成一个子步骤
- **中频报告**（信任分60-80）：每15分钟或关键里程碑
- **低频报告**（信任分>80）：每30分钟或任务完成

#### 报告内容模板
```
[任务监督报告]
任务ID: {task_id}
任务目标: {goal}
当前步骤: {step_name} ({progress}%)
下一步骤: {next_step}
预计完成: {eta}
风险提示: {risks}
用户操作: [查看详情] [暂停] [调整] [继续]
```

### 3. 风险预警与异常处理

#### 风险等级定义
| 风险等级 | 触发条件 | 监督响应 |
|---------|---------|---------|
| **低风险** | 计划内小偏差 | 记录日志，继续执行 |
| **中风险** | 计划外但可控 | 通知用户，可选审批 |
| **高风险** | 可能影响系统稳定 | 暂停任务，等待审批 |
| **危急风险** | 威胁系统生存 | 自动中止，进入安全模式 |

#### 异常处理流程
```
检测异常 → 评估风险等级 → 选择处理策略 → 执行处理 → 报告用户
```

### 4. 动态信任调整机制

#### 监督强度矩阵
| 信任分 | 审批频率 | 报告频率 | 自主决策范围 |
|-------|---------|---------|------------|
| <30分 | 每个步骤 | 每2分钟 | 无（完全监督） |
| 30-60分 | 关键步骤 | 每5分钟 | 低风险操作 |
| 60-80分 | 里程碑 | 每15分钟 | 中风险操作 |
| >80分 | 最终结果 | 每30分钟 | 大部分操作 |

## 🛠️ 技术实现方案

### 核心组件设计

#### 1. 任务监督器 (TaskSupervisor)
```python
class TaskSupervisor:
    """任务监督器 - 核心监督组件"""
    
    def __init__(self):
        self.active_tasks: Dict[str, SupervisedTask] = {}
        self.approval_pending: Dict[str, ApprovalRequest] = {}
    
    def start_supervised_task(self, task_goal: str, user_id: str) -> str:
        """启动监督任务"""
        # 1. 任务分解（基于信任分）
        # 2. 设置审批点
        # 3. 启动任务执行
        # 4. 初始化监督报告
        
    def request_approval(self, task_id: str, approval_type: str, data: Dict) -> None:
        """请求用户审批"""
        # 记录审批请求，等待用户响应
        
    def process_approval(self, task_id: str, decision: str, notes: str = "") -> None:
        """处理用户审批决定"""
        # 更新任务状态，继续执行
        
    def generate_progress_report(self, task_id: str) -> Dict:
        """生成进度报告"""
```

#### 2. 监督界面 (SupervisionInterface)
```python
class SupervisionInterface:
    """监督界面 - 用户交互层"""
    
    def display_active_tasks(self) -> List[Dict]:
        """显示活跃任务列表"""
        
    def show_task_details(self, task_id: str) -> Dict:
        """显示任务详情"""
        
    def show_approval_request(self, approval_id: str) -> Dict:
        """显示审批请求"""
        
    def submit_approval_decision(self, approval_id: str, decision: str) -> None:
        """提交审批决定"""
```

#### 3. 信任自适应器 (TrustAdaptiveSupervisor)
```python
class TrustAdaptiveSupervisor:
    """信任自适应监督器"""
    
    def adjust_supervision_level(self, task_id: str, performance_score: float) -> None:
        """根据表现调整监督强度"""
        # 任务表现好 → 降低监督强度
        # 任务表现差 → 提高监督强度
```

### 集成方案

#### 与现有系统集成
1. **工作流编排器集成**：`workflow_orchestrator.py` 扩展支持监督事件
2. **信任系统集成**：`trust_system.py` 提供信任分用于调整监督强度
3. **事件系统集成**：`event_system.py` 发布监督相关事件
4. **记忆系统集成**：记忆系统存储监督历史和审批记录

#### 监督事件类型扩展
```python
class SupervisionEventType(Enum):
    """监督事件类型"""
    TASK_SUPERVISION_STARTED = "task_supervision_started"
    APPROVAL_REQUESTED = "approval_requested"
    APPROVAL_RECEIVED = "approval_received"
    SUPERVISION_REPORT_GENERATED = "supervision_report_generated"
    SUPERVISION_LEVEL_CHANGED = "supervision_level_changed"
    TASK_PAUSED_FOR_SUPERVISION = "task_paused_for_supervision"
```

## 📋 实施步骤

### 第一阶段：基础监督框架（1-2天）
1. **设计数据结构**：监督任务、审批请求、监督报告
2. **实现核心组件**：TaskSupervisor基础功能
3. **扩展事件系统**：添加监督事件类型
4. **基础测试**：验证监督流程可行性

### 第二阶段：用户界面集成（1-2天）
1. **实现监督界面**：任务列表、详情、审批界面
2. **集成到工作流**：现有任务启动流程添加监督选项
3. **信任系统集成**：基于信任分调整监督强度
4. **端到端测试**：完整监督流程测试

### 第三阶段：高级功能（2-3天）
1. **实现自适应监督**：TrustAdaptiveSupervisor
2. **风险预警系统**：集成创新协调器的风险检测
3. **历史学习**：基于历史监督效果优化监督策略
4. **压力测试**：多任务并发监督测试

### 第四阶段：优化部署（1天）
1. **性能优化**：监督开销最小化
2. **用户体验优化**：简化审批流程
3. **文档完善**：用户和监督指南
4. **生产部署**：集成到主系统

## ⚖️ 宪法合规检查

### 宪法第1条：最小生命单元原则 ✅
- 监督组件设计为独立模块（≤200行）
- 可独立运行，不增加系统核心复杂性

### 宪法第2条：协议驱动进化原则 ✅
- 监督机制通过L2/L3协议引入
- 用户可随时启用/禁用监督功能

### 宪法第3条：认知对齐优先原则 ✅
- 监督确保任务执行符合用户意图
- 用户反馈直接指导任务调整

### 宪法第4条：生存优先原则 ✅
- 监督机制包含风险检测和自动中止
- 危急情况下优先保护系统稳定

### 宪法第5条：审查必行原则 ✅
- 监督历史完整记录，可供审查
- 监督效果定期评估和优化

## 🎯 成功标准

### 功能成功标准
- ✅ 用户可启动监督任务
- ✅ 系统按信任分自动设置监督强度
- ✅ 关键节点审批流程正常工作
- ✅ 实时进展报告按时生成
- ✅ 风险预警准确触发

### 性能成功标准
- ✅ 监督开销<5%任务执行时间
- ✅ 审批响应延迟<2秒
- ✅ 报告生成时间<1秒
- ✅ 支持并发监督≥3个任务

### 用户体验成功标准
- ✅ 用户理解监督机制目的
- ✅ 审批流程简单直观
- ✅ 进展报告清晰有用
- ✅ 用户感觉控制感增强

## 📊 验证方案

### 测试用例设计
1. **基础监督流程测试**：启动、审批、报告、完成
2. **信任自适应测试**：不同信任分下的监督强度调整
3. **风险处理测试**：模拟各种风险场景的监督响应
4. **并发监督测试**：多个任务同时监督的性能
5. **用户体验测试**：用户对监督机制的满意度

### 验收标准
- 所有测试用例通过率≥90%
- 用户满意度评分≥80%
- 系统稳定性无下降
- 宪法合规100%

## 🔄 与多AI窗口协作框架集成

### 监督状态同步
多AI窗口协作时，监督状态必须同步：
- 监督任务列表和状态
- 待审批请求队列
- 监督历史记录
- 用户偏好设置

### 窗口间监督交接
窗口切换时，监督任务无缝交接：
```
当前窗口 → 保存监督状态 → 生成交接报告 → 新窗口 → 恢复监督状态 → 继续监督
```

### 协作监督模式
多窗口可协作监督复杂任务：
- **主监督窗口**：负责主要监督决策
- **辅助监督窗口**：提供分析支持
- **专家咨询窗口**：特定领域建议

## 📝 下一步行动

### 立即行动（今天）
1. **用户确认设计方向**：获取用户对本设计的反馈
2. **开始第一阶段实现**：基础监督框架
3. **更新阶段二文档**：补充监督机制说明

### 短期计划（本周）
1. **完成第一阶段实现**：基础监督功能
2. **集成测试**：与现有系统集成测试
3. **用户测试**：获取初步用户反馈

### 长期规划（本月）
1. **完善高级功能**：自适应监督、风险预警
2. **性能优化**：降低监督开销
3. **文档完善**：用户指南和最佳实践

---

**设计版本**: v1.0（用户监督任务协作初始设计）  
**设计时间**: 2026年2月6日  
**设计依据**: 宪法原则、阶段二协作模式定义、用户要求  
**设计目标**: 填补阶段二监督机制空白，实现真正的"任务协作"模式  

> **设计理念**: 监督不是为了限制，而是为了增强。好的监督让AI更自主，让用户更放心。